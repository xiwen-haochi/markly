<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>链接收藏家</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <!-- ===== 主页（纯本地） ===== -->
  <div id="main-page" class="page">
    <!-- 顶栏 -->
    <div class="nav-bar">
      <span class="nav-title">📌 Markly — 智链收藏</span>
      <div class="nav-actions">
        <button id="btn-import" class="icon-btn" title="导入">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M3 12v2a1 1 0 001 1h10a1 1 0 001-1v-2M9 3v8M6 8l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button id="btn-export" class="icon-btn" title="导出">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M3 12v2a1 1 0 001 1h10a1 1 0 001-1v-2M9 11V3M6 6l3-3 3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button id="btn-toggle-add" class="icon-btn" title="添加收藏">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 4v12M4 10h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
        <button id="btn-settings" class="icon-btn" title="设置">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><circle cx="9" cy="9" r="2.5" stroke="currentColor" stroke-width="1.5"/><path d="M9 1.5v2M9 14.5v2M1.5 9h2M14.5 9h2M3.1 3.1l1.4 1.4M13.5 13.5l1.4 1.4M3.1 14.9l1.4-1.4M13.5 4.5l1.4-1.4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>
        </button>
      </div>
    </div>

    <!-- 搜索栏 -->
    <div class="search-bar">
      <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="6.5" cy="6.5" r="5.5" stroke="#8E8E93" stroke-width="1.5"/><path d="M11 11l4 4" stroke="#8E8E93" stroke-width="1.5" stroke-linecap="round"/></svg>
      <input type="text" id="search-input" placeholder="搜索名称、标题、标签、内容..." />
      <button id="btn-clear-search" class="clear-btn" style="display:none;">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><circle cx="7" cy="7" r="7" fill="#C7C7CC"/><path d="M4.5 4.5l5 5M9.5 4.5l-5 5" stroke="#fff" stroke-width="1.2" stroke-linecap="round"/></svg>
      </button>
    </div>

    <!-- 视图切换 -->
    <div class="segmented-control">
      <button class="seg-btn active" data-view="list">全部</button>
      <button class="seg-btn" data-view="readlater">待读</button>
      <button class="seg-btn" data-view="tags">标签分组</button>
    </div>

    <!-- 添加面板 -->
    <div id="add-panel" class="add-panel collapsed">
      <div class="panel-content">
        <div class="input-group"><input type="text" id="add-url" placeholder="当前页面链接" readonly /></div>
        <div class="input-group"><input type="text" id="add-name" placeholder="自定义名称（选填）" /></div>
        <div class="input-group"><input type="text" id="add-title" placeholder="页面标题（自动获取）" readonly /></div>
        <!-- 标签输入组件 -->
        <div class="tag-input-wrap" id="tag-input-wrap">
          <div class="tag-input-tags" id="tag-input-tags"></div>
          <input type="text" id="add-tags-input" class="tag-input-field" placeholder="输入标签后按 Enter" autocomplete="off" />
          <div class="tag-suggestions" id="tag-suggestions"></div>
        </div>
        <!-- 智能标签（AI 提取 + 可手动添加） -->
        <div id="ai-tags-display" class="ai-tags-display" style="display:none;">
          <div class="ai-tags-label">✨ 智能标签</div>
          <div id="ai-tags-pills" class="ai-tags-pills"></div>
          <input type="text" id="ai-tags-input" class="ai-tag-input-field" placeholder="输入智能标签后按 Enter" autocomplete="off" />
        </div>
        <div class="input-group"><textarea id="add-summary" placeholder="内容摘要（自动提取或 AI 生成）" rows="2"></textarea></div>
        <div class="panel-actions">
          <button id="btn-fetch" class="btn-apple btn-tinted btn-sm">提取摘要</button>
          <button id="btn-fetch-ai" class="btn-apple btn-ai btn-sm" title="需先配置 AI">✨ AI 提取</button>
          <button id="btn-save" class="btn-apple btn-filled btn-sm">保存收藏</button>
        </div>
        <div id="add-msg" class="toast"></div>
      </div>
    </div>

    <!-- 列表视图 -->
    <div id="list-view" class="view-container">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="display:flex;gap:4px;align-items:center;">
          <button id="btn-view-card" class="view-mode-btn active" title="卡片视图">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="1" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.3"/><rect x="9" y="1" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.3"/><rect x="1" y="9" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.3"/><rect x="9" y="9" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.3"/></svg>
          </button>
          <button id="btn-view-compact" class="view-mode-btn" title="紧凑列表">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1 3h14M1 7h14M1 11h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
        </div>
        <button id="btn-check-links" class="btn-check-links" title="检测失效链接">🔗 检测链接</button>
      </div>
      <div id="results" class="results-list"></div>
    </div>

    <!-- 待读视图 -->
    <div id="readlater-view" class="view-container" style="display:none;">
      <div id="readlater-results" class="results-list"></div>
    </div>

    <!-- 标签分组视图 -->
    <div id="tags-view" class="view-container" style="display:none;">
      <div id="tag-groups" class="tag-groups"></div>
    </div>

    <!-- ===== 设置面板（覆盖层） ===== -->
    <div id="settings-panel" class="settings-panel" style="display:none;">
      <div class="settings-header">
        <button id="btn-settings-back" class="btn-apple btn-plain btn-sm">← 返回</button>
        <span class="settings-title">设置</span>
        <span style="width:56px;"></span>
      </div>
      <div class="settings-body">
        <div class="setting-section">
          <div class="setting-label">AI 提取配置</div>
          <p class="setting-hint">配置后可使用 AI 自动提取标题、标签和摘要。<br>支持 OpenAI / DeepSeek / Ollama 等兼容接口。</p>
          <div class="input-group">
            <input type="text" id="ai-api-url" placeholder="API 地址，如 https://api.openai.com/v1" />
          </div>
          <div class="input-group">
            <input type="password" id="ai-api-key" placeholder="API Key" />
          </div>
          <div class="input-group">
            <input type="text" id="ai-model" placeholder="模型名称，如 gpt-4o-mini" />
          </div>
          <div class="input-group">
            <textarea id="ai-prompt" placeholder="自定义提示词（可选，留空使用默认）" rows="3"></textarea>
          </div>
          <div class="input-group">
            <input type="text" id="ai-output-lang" placeholder="留空则跟随原文语言，如填 中文 则强制翻译" />
          </div>
          <p class="setting-hint" style="margin-top:-4px;margin-bottom:8px;">AI 提取的摘要和标签将翻译为该语言输出，留空默认中文</p>
          <label class="setting-toggle">
            <input type="checkbox" id="ai-enable-images" />
            <span class="toggle-text">支持图片分析（需模型支持视觉）</span>
          </label>
          <p class="setting-hint" style="margin-top:2px;margin-bottom:8px;">启用后提取页面最多 3 张主要图片供 AI 分析，需模型支持视觉能力（如 gpt-4o、qwen-vl 等）</p>
          <button id="btn-save-ai" class="btn-apple btn-filled btn-sm" style="width:100%;margin-top:8px;">保存 AI 配置</button>
          <div id="ai-token-usage" class="token-usage"></div>
          <div id="ai-config-msg" class="toast" style="margin-top:8px;"></div>
        </div>
        <div class="setting-section" style="margin-top:16px;">
          <div class="setting-label">外观</div>
          <div class="theme-toggle">
            <span class="toggle-text">主题模式</span>
            <select id="theme-select" class="theme-select">
              <option value="auto">跟随系统</option>
              <option value="light">浅色</option>
              <option value="dark">深色</option>
            </select>
          </div>
        </div>
        <div class="setting-section" style="margin-top:16px;">
          <div class="setting-label">说明</div>
          <p class="setting-hint">• 所有数据存储在浏览器本地，不上传任何服务器<br>• API 地址只需填写到 /v1 即可，系统会自动补全<br>• 字节示例：https://ark.cn-beijing.volces.com/api/v3<br>• 支持导入/导出 CSV 文件备份数据</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 隐藏的文件选择器 -->
  <input type="file" id="import-file" accept=".html,.htm,.csv" style="display:none;" />

  <script src="popup.js"></script>
</body>
</html>
